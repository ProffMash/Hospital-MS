# Generated by Django 5.1.3 on 2025-09-21 21:23

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('hms', '0015_alter_user_role'),
    ]

    operations = [
        # Replace the simple AlterField with explicit SQL steps so we can
        # convert existing textual values to valid JSON safely. Some rows
        # may contain plain unquoted tokens like: malaria which cause the
        # ALTER COLUMN ... TYPE json/jsonb cast to fail. We add a new
        # jsonb column, populate it using to_jsonb(...) which wraps text
        # values into JSON strings, then swap columns.
        migrations.RunSQL(
            sql='''
            -- Add a temporary jsonb column
            ALTER TABLE hms_labresults ADD COLUMN result_json jsonb;

            -- Populate it by converting the existing value to JSON.
            -- to_jsonb(text) will convert plain text like: malaria -> "malaria"
            UPDATE hms_labresults SET result_json = to_jsonb(result);

            -- Drop the old column and rename the new one into place
            ALTER TABLE hms_labresults DROP COLUMN result;
            ALTER TABLE hms_labresults RENAME COLUMN result_json TO result;
            ''',
            reverse_sql='''
            -- Reverse: create text column and copy json values as text
            ALTER TABLE hms_labresults ADD COLUMN result_text text;
            UPDATE hms_labresults SET result_text = result::text;
            ALTER TABLE hms_labresults DROP COLUMN result;
            ALTER TABLE hms_labresults RENAME COLUMN result_text TO result;
            ''',
        ),
    ]
